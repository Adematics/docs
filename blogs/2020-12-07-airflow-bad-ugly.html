<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Airflow, the Bad and the Ugly! | Kestra</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Airflow, the Bad and the Ugly! | The modern, scalable orchestrator & scheduler open source platform.">
    <meta property="article:published_time" content="2020-12-07T00:00:00.000Z">
    <meta property="article:modified_time" content="2020-12-03T20:59:28.000Z">
    <meta property="og:site_name" content="Kestra">
    <meta property="og:title" content="Airflow, the Bad and the Ugly!">
    <meta property="og:description" content="Airflow, the Bad and the Ugly! | The modern, scalable orchestrator & scheduler open source platform.">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/blogs/2020-12-07-airflow-bad-ugly.html">
    <meta property="og:image" content="/blogs/2020-12-07-airflow-bad-ugly.jpg">
    <meta name="twitter:title" content="Airflow, the Bad and the Ugly!">
    <meta name="twitter:description" content="Airflow, the Bad and the Ugly! | The modern, scalable orchestrator & scheduler open source platform.">
    <meta name="twitter:url" content="/blogs/2020-12-07-airflow-bad-ugly.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/blogs/2020-12-07-airflow-bad-ugly.jpg">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="airflow">
    <meta property="article:tag" content="airflow">
    
    <link rel="preload" href="/assets/css/0.styles.c136d455.css" as="style"><link rel="preload" href="/assets/js/app.135e5227.js" as="script"><link rel="preload" href="/assets/js/19.f2b419e8.js" as="script"><link rel="preload" href="/assets/js/1.ca80e02f.js" as="script"><link rel="preload" href="/assets/js/17.a1190153.js" as="script"><link rel="preload" href="/assets/js/10.54554328.js" as="script"><link rel="prefetch" href="/assets/js/100.31a5c2a9.js"><link rel="prefetch" href="/assets/js/101.e5bfcc1f.js"><link rel="prefetch" href="/assets/js/102.64d08281.js"><link rel="prefetch" href="/assets/js/103.0acfdcaa.js"><link rel="prefetch" href="/assets/js/104.c77c6b9b.js"><link rel="prefetch" href="/assets/js/105.452c26e0.js"><link rel="prefetch" href="/assets/js/106.d40cd367.js"><link rel="prefetch" href="/assets/js/107.d093a5dd.js"><link rel="prefetch" href="/assets/js/108.788ea4b7.js"><link rel="prefetch" href="/assets/js/109.b81b6f0e.js"><link rel="prefetch" href="/assets/js/11.1d1290fe.js"><link rel="prefetch" href="/assets/js/110.c7d3908e.js"><link rel="prefetch" href="/assets/js/111.352b9720.js"><link rel="prefetch" href="/assets/js/112.00c64c12.js"><link rel="prefetch" href="/assets/js/113.405ddb2b.js"><link rel="prefetch" href="/assets/js/114.d9d5f139.js"><link rel="prefetch" href="/assets/js/115.f8e2fdd9.js"><link rel="prefetch" href="/assets/js/116.25827342.js"><link rel="prefetch" href="/assets/js/117.3083e76e.js"><link rel="prefetch" href="/assets/js/118.534508f5.js"><link rel="prefetch" href="/assets/js/119.30e4e0d8.js"><link rel="prefetch" href="/assets/js/12.be2988cd.js"><link rel="prefetch" href="/assets/js/120.1115cd30.js"><link rel="prefetch" href="/assets/js/121.5b9f90a8.js"><link rel="prefetch" href="/assets/js/122.4cf7ab8f.js"><link rel="prefetch" href="/assets/js/123.a0059b6f.js"><link rel="prefetch" href="/assets/js/124.620f824d.js"><link rel="prefetch" href="/assets/js/125.dea03c3f.js"><link rel="prefetch" href="/assets/js/126.e05805b2.js"><link rel="prefetch" href="/assets/js/127.9117385c.js"><link rel="prefetch" href="/assets/js/128.ba27b8b9.js"><link rel="prefetch" href="/assets/js/129.e82c2e1b.js"><link rel="prefetch" href="/assets/js/13.215da908.js"><link rel="prefetch" href="/assets/js/130.a53b6777.js"><link rel="prefetch" href="/assets/js/131.93cefcce.js"><link rel="prefetch" href="/assets/js/132.5a4201bb.js"><link rel="prefetch" href="/assets/js/133.bd1995be.js"><link rel="prefetch" href="/assets/js/134.385c2aae.js"><link rel="prefetch" href="/assets/js/135.93885450.js"><link rel="prefetch" href="/assets/js/136.17cca7d1.js"><link rel="prefetch" href="/assets/js/137.4d30a0e4.js"><link rel="prefetch" href="/assets/js/138.329b0966.js"><link rel="prefetch" href="/assets/js/139.f72ed573.js"><link rel="prefetch" href="/assets/js/14.dd35b52d.js"><link rel="prefetch" href="/assets/js/140.3ef5bb0d.js"><link rel="prefetch" href="/assets/js/141.d766f189.js"><link rel="prefetch" href="/assets/js/142.6f3419eb.js"><link rel="prefetch" href="/assets/js/143.64bddf77.js"><link rel="prefetch" href="/assets/js/144.95cc9f5c.js"><link rel="prefetch" href="/assets/js/145.e14774f1.js"><link rel="prefetch" href="/assets/js/146.dcc8fa77.js"><link rel="prefetch" href="/assets/js/147.cab4886a.js"><link rel="prefetch" href="/assets/js/148.245ad489.js"><link rel="prefetch" href="/assets/js/15.3e9d888a.js"><link rel="prefetch" href="/assets/js/16.5ba9ba00.js"><link rel="prefetch" href="/assets/js/18.c8bd749a.js"><link rel="prefetch" href="/assets/js/20.7c285105.js"><link rel="prefetch" href="/assets/js/21.db66c578.js"><link rel="prefetch" href="/assets/js/22.8b027885.js"><link rel="prefetch" href="/assets/js/23.21a50102.js"><link rel="prefetch" href="/assets/js/24.2f328819.js"><link rel="prefetch" href="/assets/js/25.273f4ad9.js"><link rel="prefetch" href="/assets/js/26.9e5dc1a2.js"><link rel="prefetch" href="/assets/js/27.c644ae04.js"><link rel="prefetch" href="/assets/js/28.6b2fb8f7.js"><link rel="prefetch" href="/assets/js/29.f97cdfd8.js"><link rel="prefetch" href="/assets/js/3.98c17989.js"><link rel="prefetch" href="/assets/js/30.8d0f4e64.js"><link rel="prefetch" href="/assets/js/31.67c3b9a4.js"><link rel="prefetch" href="/assets/js/32.752f552e.js"><link rel="prefetch" href="/assets/js/33.8706a136.js"><link rel="prefetch" href="/assets/js/34.be26e040.js"><link rel="prefetch" href="/assets/js/35.adfe5ae8.js"><link rel="prefetch" href="/assets/js/36.1285a47b.js"><link rel="prefetch" href="/assets/js/37.850cdb6d.js"><link rel="prefetch" href="/assets/js/38.cb451ac5.js"><link rel="prefetch" href="/assets/js/39.bddd6daa.js"><link rel="prefetch" href="/assets/js/4.eb5a15b8.js"><link rel="prefetch" href="/assets/js/40.2c777ad1.js"><link rel="prefetch" href="/assets/js/41.54481030.js"><link rel="prefetch" href="/assets/js/42.53541862.js"><link rel="prefetch" href="/assets/js/43.fd554a5e.js"><link rel="prefetch" href="/assets/js/44.ca341c56.js"><link rel="prefetch" href="/assets/js/45.6ed4efcc.js"><link rel="prefetch" href="/assets/js/46.1bc4e48e.js"><link rel="prefetch" href="/assets/js/47.3a911446.js"><link rel="prefetch" href="/assets/js/48.485ceaa9.js"><link rel="prefetch" href="/assets/js/49.7dab4c2b.js"><link rel="prefetch" href="/assets/js/5.89148211.js"><link rel="prefetch" href="/assets/js/50.ffe4d485.js"><link rel="prefetch" href="/assets/js/51.3bc55bf3.js"><link rel="prefetch" href="/assets/js/52.2c2ce08c.js"><link rel="prefetch" href="/assets/js/53.c6670ea5.js"><link rel="prefetch" href="/assets/js/54.7261b04a.js"><link rel="prefetch" href="/assets/js/55.cb18bde2.js"><link rel="prefetch" href="/assets/js/56.0769295a.js"><link rel="prefetch" href="/assets/js/57.c01a3827.js"><link rel="prefetch" href="/assets/js/58.8897c6c5.js"><link rel="prefetch" href="/assets/js/59.eda75924.js"><link rel="prefetch" href="/assets/js/6.aaf7c5f8.js"><link rel="prefetch" href="/assets/js/60.43eca9aa.js"><link rel="prefetch" href="/assets/js/61.a2de912d.js"><link rel="prefetch" href="/assets/js/62.797c8e9b.js"><link rel="prefetch" href="/assets/js/63.a8304a50.js"><link rel="prefetch" href="/assets/js/64.73e4e9c5.js"><link rel="prefetch" href="/assets/js/65.716d114b.js"><link rel="prefetch" href="/assets/js/66.383f1a29.js"><link rel="prefetch" href="/assets/js/67.56e1d0cb.js"><link rel="prefetch" href="/assets/js/68.74b27ca8.js"><link rel="prefetch" href="/assets/js/69.6ccb9b47.js"><link rel="prefetch" href="/assets/js/7.7e74e617.js"><link rel="prefetch" href="/assets/js/70.01dc77ac.js"><link rel="prefetch" href="/assets/js/71.2f3b22b5.js"><link rel="prefetch" href="/assets/js/72.b6740e06.js"><link rel="prefetch" href="/assets/js/73.ea3d8d4d.js"><link rel="prefetch" href="/assets/js/74.de251b01.js"><link rel="prefetch" href="/assets/js/75.4a83f421.js"><link rel="prefetch" href="/assets/js/76.fcafdaa1.js"><link rel="prefetch" href="/assets/js/77.fcadc156.js"><link rel="prefetch" href="/assets/js/78.2c96f636.js"><link rel="prefetch" href="/assets/js/79.44a2f79a.js"><link rel="prefetch" href="/assets/js/8.786ff0cc.js"><link rel="prefetch" href="/assets/js/80.51729c49.js"><link rel="prefetch" href="/assets/js/81.581fd82d.js"><link rel="prefetch" href="/assets/js/82.4db30d68.js"><link rel="prefetch" href="/assets/js/83.e4aafba3.js"><link rel="prefetch" href="/assets/js/84.76a14a9b.js"><link rel="prefetch" href="/assets/js/85.9048fbb6.js"><link rel="prefetch" href="/assets/js/86.e5846763.js"><link rel="prefetch" href="/assets/js/87.18e29870.js"><link rel="prefetch" href="/assets/js/88.b8fbfc24.js"><link rel="prefetch" href="/assets/js/89.5b72f4d5.js"><link rel="prefetch" href="/assets/js/9.4e669899.js"><link rel="prefetch" href="/assets/js/90.7885860f.js"><link rel="prefetch" href="/assets/js/91.111c74e2.js"><link rel="prefetch" href="/assets/js/92.a50ecb09.js"><link rel="prefetch" href="/assets/js/93.38c9de33.js"><link rel="prefetch" href="/assets/js/94.d915aaa5.js"><link rel="prefetch" href="/assets/js/95.63d9e664.js"><link rel="prefetch" href="/assets/js/96.4ae5ed12.js"><link rel="prefetch" href="/assets/js/97.f2d9e59d.js"><link rel="prefetch" href="/assets/js/98.d0336740.js"><link rel="prefetch" href="/assets/js/99.4e83a18a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c136d455.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container landing"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="Kestra" class="logo"> <span class="site-name can-hide">Kestra</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  Documentation
</a></div><div class="nav-item"><a href="/plugins/" class="nav-link">
  Plugins
</a></div> <a href="https://github.com/kestra-io/kestra" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <main class="page"><section class="bg-half d-table w-100" style="background-image:url(/blogs/2020-12-07-airflow-bad-ugly.jpg);"><div class="bg-overlay"></div> <div class="container"><div class="row justify-content-center"><div class="col-lg-12 text-center"><div class="page-next-level"><h4 class="title text-white title-dark">Airflow, the Bad and the Ugly!</h4> <div class="page-next"><nav aria-label="breadcrumb" class="d-inline-block"><ul class="breadcrumb bg-white rounded shadow mb-0"><li class="breadcrumb-item"><a href="/" class="router-link-active">Kestra</a></li> <li class="breadcrumb-item"><a href="/blogs">Blog</a></li> <li aria-current="page" class="breadcrumb-item active">
                                                Airflow, the Bad and the Ugly!
                                            </li></ul></nav></div></div></div></div></div></section> <div class="position-relative"><div class="shape overflow-hidden text-white"><svg viewBox="0 0 2880 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 48H1437.5H2880V0H2160C1442.5 52 720 0 720 0H0V48Z" fill="currentColor"></path></svg></div></div> <div class="container"><div class="theme-default-content custom content__default"><p>Airflow is defined for now as a clear winner for open source orchestration tools. So like everyone, reading medium on the web, we are thinking this tool is mature and will resolved all the constraint we have to schedule, orchestrate &amp; monitor our dags.</p> <p>Mostly this blog post will be technical focus but let you overview the major issue we have with Airflow trying to make it the main orchestrator for our data pipeline and will describe our long road to hell to lead us to create &amp; open source <a href="/" class="router-link-active">Kestra</a> based on the frustration using Airflow.</p> <p>Without any order, here is the major point that we have discovered, and we want to share with you :</p> <hr> <p></p><div class="table-of-contents"><ul><li><a href="#workflow-as-code-not-so-good-idea">Workflow as code, not so good idea !</a></li><li><a href="#realtime-baby">Realtime baby !</a></li><li><a href="#events-based-api-first">Events based &amp; API First</a><ul><li><a href="#api-not-so-first">API not so first</a></li><li><a href="#what-events">What Events ?</a></li></ul></li><li><a href="#stable">Stable ? ...</a></li><li><a href="#scalability-hum-hum">Scalability, hum hum ...</a><ul><li><a href="#save-my-cpu">Save my CPU</a></li><li><a href="#where-is-the-spof">Where is the SPOF ?</a></li></ul></li><li><a href="#dynamic-workflows">Dynamic workflows !</a><ul><li><a href="#first-one-are-dynamic-tasks">First one are dynamic tasks.</a></li><li><a href="#second-are-sensors">Second are sensors.</a></li><li><a href="#task-outputs-vs-xcom">Task outputs vs XCom</a></li><li><a href="#where-is-my-files">Where is my files ?</a></li></ul></li><li><a href="#entreprise-not-so-ready">Entreprise not so ready !</a><ul><li><a href="#please-keep-my-revision">Please keep my revision !</a></li><li><a href="#where-is-the-rbac">Where is the RBAC ?</a></li></ul></li></ul></div><p></p> <h2 id="workflow-as-code-not-so-good-idea"><a href="#workflow-as-code-not-so-good-idea" class="header-anchor">#</a> Workflow as code, not so good idea !</h2> <p>Airflow dag are defined as python code ! First look seems to be a good idea but in the fact it can be a very dangerous pattern. Lets me explain a real use case.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>bash_operator <span class="token keyword">import</span> BashOperator
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>dates <span class="token keyword">import</span> days_ago
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">get_command</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;echo '</span><span class="token interpolation"><span class="token punctuation">{</span>arg<span class="token punctuation">}</span></span><span class="token string">'&quot;</span></span>

default_args <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'owner'</span><span class="token punctuation">:</span> <span class="token string">'airflow'</span><span class="token punctuation">,</span>
    <span class="token string">'depends_on_past'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token string">'start_date'</span><span class="token punctuation">:</span> days_ago<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
        <span class="token string">'sleep'</span><span class="token punctuation">,</span>
        default_args<span class="token operator">=</span>default_args<span class="token punctuation">,</span>
        schedule_interval<span class="token operator">=</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>
    task_1 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">'first_task'</span><span class="token punctuation">,</span>
        bash_command<span class="token operator">=</span>get_command<span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    task_2 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">'second_task'</span><span class="token punctuation">,</span>
        bash_command<span class="token operator">=</span>get_command<span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

task_1 <span class="token operator">&gt;&gt;</span> task_2
</code></pre></div><p>Simple and working and let's change the function <code>get_bash_print</code> with a function that will do an heavy computing task (like fetching database, ...) . Still working, but in this case, the whole airflow instance is in danger. Airflow evaluate dag a <strong>lot of time in all services</strong> (webserver, worker, scheduler, ...).<br>
Imagine an Airflow as self-service for a large company, a simple dag could break <strong>the whole platform</strong>.</p> <p>How can you prevent this to happen ? You need to have a strong review of each dags to be sure that no heavy compute are done outside of an Operator. Still, it's possible, but it will be really hard on a large scale company cluster.</p> <p>Now we are changing the function with a sleep (that would simulate any heavy work):</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_bash_print</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;Hello from a </span><span class="token interpolation"><span class="token punctuation">{</span>arg<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
</code></pre></div><p>And run <code>airflow list_dags -r</code>, this command will expose the parsing time for all the dag, that will be done <strong>every x seconds</strong> on webserver and scheduler and before <strong>any task</strong> on workers:</p> <div class="language- extra-class"><pre class="language-text"><code>-------------------------------------------------------------------
DagBag loading stats for /usr/local/airflow/dags
-------------------------------------------------------------------
Number of DAGs: 2
Total task number: 4
DagBag parsing time: 10.130541999999993
-------------------------------------------------------------------------------------------------------+--------------------+---------+----------+------------------------------------------------------------------------------
file                                                                                                   | duration           | dag_num | task_num | dags                                                                         
-------------------------------------------------------------------------------------------------------+--------------------+---------+----------+------------------------------------------------------------------------------
/sleep.py                                                                                              | 10.018332000000001 |       1 |        2 | ['sleep']                                                                    
/bash.py                                                                                               | 0.002396           |       1 |        2 | ['bash']
-------------------------------------------------------------------------------------------------------+--------------------+---------+----------+------------------------------------------------------------------------------
</code></pre></div><p>Simple experiment, let's create the same dag and remove the <code>time.sleep</code> and trigger it from the ui dag. Look at this taskrun:<br> <img src="/assets/img/1.17acd297.png" alt="Flow list"><br>
As you can see, there is a huge gap between tasks! and it's only because the <code>sleep</code> dag exists on the current cluster, even if the <code>bash</code> dag is fast, it will be slow down by other dag.</p> <p>You got it ? Yeah, you have successfully slow down your Airflow <strong>whole cluster</strong>. Worst, imagine that this task will fetch any external service, you could <strong>overload &amp; crash</strong> this service, since Airflow scan <strong>everytime all dags</strong> even if the dag is not running.<br>
You can mitigate this using a strong dag review process, but it will not scale well on a shared large cluster used by a lots of independent teams</p> <div class="custom-block tip"><p class="custom-block-title">Conclusion</p> <p>It's why Kestra have chosen a declarative language for its workflow engine, since all flow are isolated and serialized preventing any code injection.<br>
You can scale to thousands of flows, not matter how there are configured, there will be not impact on your cluster since flow are only evaluated at runtime.</p></div> <h2 id="realtime-baby"><a href="#realtime-baby" class="header-anchor">#</a> Realtime baby !</h2> <p>Airflow is not build with realtime in mind, the ui is a static, server side generated app. When using airflow UI you <strong>will hit F5</strong> or refresh all the time.<br>
You want to know if the dag is running, hit F5 is the only solution ! Same for logs !</p> <h2 id="events-based-api-first"><a href="#events-based-api-first" class="header-anchor">#</a> Events based &amp; API First</h2> <p>Airflow was born with a simple concept, schedule a dag at this time ! Every else is not in the mindset of Airflow.</p> <h3 id="api-not-so-first"><a href="#api-not-so-first" class="header-anchor">#</a> API not so first</h3> <p>There is an <a href="https://airflow.apache.org/docs/stable/rest-api-ref.html" target="_blank" rel="noopener noreferrer">expirimental API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> but clearly insufficient for a real world.<br>
For example, the <a href="https://airflow.apache.org/docs/stable/rest-api-ref.html#post--api-experimental-dags--DAG_ID--dag_runs" target="_blank" rel="noopener noreferrer">trigger dag API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> can be used passing some args, but the server don't know these! So it will let passed some mandatory arguments and create a DagRun that will failed.</p> <p>In other hand, Kestra was built with a strong API, everything can be done with API, create a flow, execute it, ... That let you integrate Kestra in company the way you want to use it.</p> <h3 id="what-events"><a href="#what-events" class="header-anchor">#</a> What Events ?</h3> <p>Airflow have a mandatory dag options <code>start_date</code> &amp; <code>schedule_interval</code>! Meaning that all is thinking like a crontab with a start date.<br>
But wait, in real life, we don't want to schedule a flow, we want to start when an external event occurs (like a new file on a storage for example).</p> <p>Airflow is not the right tool for this use case! Kestra handle it with <strong>optional</strong> <a href="/docs/concepts/flows.html#triggers">trigger</a> that allow you handle events (time or anything else) like a reason to start an execution and follow it.</p> <h2 id="stable"><a href="#stable" class="header-anchor">#</a> Stable ? ...</h2> <p>Let me give some insight. So we start by testing a simple use case that will represent our real usage from our data pipeline: Doing lots of different dags that would simply call external API, you understand me ELT here.</p> <p>In order to prove the stability of Airflow, we simply simulate some kind of real workflow, 200 dags with each 15/20 tasks with external api, simulate here with a <code>sleep 1</code>. We launch the test at the same time, what we expect to have on daily basis at least.<br>
We use <a href="https://airflow.apache.org/docs/stable/_modules/airflow/example_dags/example_bash_operator.html" target="_blank" rel="noopener noreferrer">example_bash_operator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and just change the range from 5 to 15 and activate all the task at the same time.</p> <p>We will keep you about commenting the execution time of this test that take really longer than we expect, worst are :<br> <img src="/assets/img/2.c4d518ee.png" alt="Airflow failed some tasks"><br>
Yes this is <strong>failed task</strong> ! How can a scheduler can failed task with <code>sleep 1</code> !</p> <p>How can I monitor my daily flows if I need to have some failed tasks <strong>only due to the scheduler</strong>!</p> <h2 id="scalability-hum-hum"><a href="#scalability-hum-hum" class="header-anchor">#</a> Scalability, hum hum ...</h2> <p>From airflow documentation :</p> <blockquote><p>Scalable: Airflow has a modular architecture and uses a message queue to orchestrate an arbitrary number of workers. Airflow is ready to scale to infinity.</p></blockquote> <h3 id="save-my-cpu"><a href="#save-my-cpu" class="header-anchor">#</a> Save my CPU</h3> <p>At first, we have believed the marketing baseline, but the road was not so happy.<br>
When we start the <a href="#stable--">bench</a> below, this one will use the whole 16 core of the servers I was using just doing sleep.</p> <p>In fact, Airflow is a python software that handle scalability with <a href="https://airflow.apache.org/docs/stable/executor/celery.html" target="_blank" rel="noopener noreferrer">Celery executor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Celery will fork many airflow process, not sharing anything.<br>
When I start a dag, the scheduler will scan every x seconds all the dags, worker for every task will scan all the dags on the cluster, this will use a lots of CPU for large cluster instance, and this will be worst &amp; worst as long as you add new dag / tasks.<br>
It's <a href="https://stackoverflow.com/a/49905571/1590168" target="_blank" rel="noopener noreferrer">by design<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, Airflow must be used for long running tasks, not for lots of small / short tasks.</p> <h3 id="where-is-the-spof"><a href="#where-is-the-spof" class="header-anchor">#</a> Where is the SPOF ?</h3> <p>Airflow will not scale to infinity since a lot's of components in their architecture are scalable by desing:</p> <ul><li>Database (MySQL or Postgres): are not horizontal scalable, only vertical (raise CPU &amp; mem) since mono server.</li> <li>Queue (Redis): Aiflow use a queue that is not scalable and mono servers also</li> <li>Airflow Scheduler: handle all the task in the cluster can only have <strong>one</strong> instance on the cluster, if not there will be multiple task run for the same execution.</li></ul> <h2 id="dynamic-workflows"><a href="#dynamic-workflows" class="header-anchor">#</a> Dynamic workflows !</h2> <p>Still from Airflow documentation :</p> <blockquote><p>Dynamic: Airflow pipelines are configuration as code (Python), allowing for dynamic pipeline generation. This allows for writing code that instantiates pipelines dynamically.</p> <p>Extensible: Easily define your own operators, executors and extend the library so that it fits the level of abstraction that suits your environment.</p> <p>Elegant: Airflow pipelines are lean and explicit. Parameterizing your scripts is built into the core of Airflow using the powerful Jinja templating engine</p></blockquote> <p>Task in dags are set up using <a href="https://airflow.apache.org/docs/stable/tutorial.html#setting-up-dependencies" target="_blank" rel="noopener noreferrer">dependencies<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.<br>
You can use</p> <ul><li>Magic operator <code>&gt;&gt;</code>, <code>&lt;&lt;</code> or their more verbose api <code>t1.set_downstream([t2, t3])</code> and <code>t1.set_downstream(t2)</code>. These operators allow you to define complex workflow, handling sequential and parallel tasks, fine !</li> <li><a href="https://airflow.apache.org/docs/stable/_api/airflow/operators/branch_operator/index.html#module-airflow.operators.branch_operator" target="_blank" rel="noopener noreferrer">Branch operator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in order to choose tasks depending on previous tasks.</li> <li>Error handling using <code>on_failure_callback</code> for example.</li> <li><a href="https://airflow.apache.org/docs/stable/_api/airflow/operators/sensors/index.html" target="_blank" rel="noopener noreferrer">Sensors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in order to wait for something.</li></ul> <p>Since all these allow you to define complex workflow, Airflow lack of some major features in my opinion !</p> <h3 id="first-one-are-dynamic-tasks"><a href="#first-one-are-dynamic-tasks" class="header-anchor">#</a> First one are dynamic tasks.</h3> <p>I mean create as many tasks depending on previous tasks like <a href="/plugins/core/tasks/flows/org.kestra.core.tasks.flows.EachSequential">Each</a>.<br>
In Airflow, this is impossible, some people try to <a href="https://github.com/mastak/airflow_multi_dagrun" target="_blank" rel="noopener noreferrer">trigger others<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> dags to emulate this (like or <a href="/plugins/core/tasks/flows/org.kestra.core.tasks.flows.Flow">Flow</a>), but this will complexify the monitoring of your flow.<br>
We will need to follow 2 dags in order to understand what the issue, the main flow is success and the child are not, really complicated !</p> <h3 id="second-are-sensors"><a href="#second-are-sensors" class="header-anchor">#</a> Second are sensors.</h3> <p>In airflow, you can in the middle of a dag wait for a resource, so If you need a file on a server, the dags will start, the sensors task will wait for the file (keeping the flow running), and restart.</p> <p>In Kestra, we have reversed the way it works, <a href="../docs/architecture#scheduler">Scheduler</a> will wait for the file and will launch a new execution when the condition are match. By this way, we don't have long running dags that are just doing nothing.<br>
Also in Airflow, Sensors are blocking a worker thread waiting. In Kestra, Scheduler have a dedicated thread pool (and scalable also) for handling all time waiting, no scalabilty issue here !</p> <h3 id="task-outputs-vs-xcom"><a href="#task-outputs-vs-xcom" class="header-anchor">#</a> Task outputs vs XCom</h3> <p>In Airflow, there is no real notion of output for task (mean value that can be used for next task). Xcom are the way for Airflow to respond to thIs problems.<br>
But in the fact, there is major drawback with XCom :</p> <ul><li><strong>TODO Control this</strong> XCom are not isolated for current execution, they can be overwritten by the concurrent execution of the same dag.</li> <li>XCom are stored in the database (MySQL or Postgres) so you can store big data between tasks.</li> <li>No file here, you can exchange file between tasks (except with hack, see below) !</li></ul> <h3 id="where-is-my-files"><a href="#where-is-my-files" class="header-anchor">#</a> Where is my files ?</h3> <p>Airflow have no notion of files at the heart ! Meaning that if you want to download a file on a task and upload it anywhere on the second tasks, we need to send a viable path to the second one.</p> <p>In the practice, this can be done with a path on a local filesystem, this work, but what about isolation between flow &amp; scalability (cluster of airflow worker), this does't work. There is still hack to make it work (like Google Composer that use a GSFuse filesystem backup with Google Cloud Storage for example), but in Kestra, we have put the file at the heart with an <a href="../docs/architecture#storage">Internal Storage</a> that will allow any task to output files like any others outputs (string, int, ...)</p> <h2 id="entreprise-not-so-ready"><a href="#entreprise-not-so-ready" class="header-anchor">#</a> Entreprise not so ready !</h2> <h3 id="please-keep-my-revision"><a href="#please-keep-my-revision" class="header-anchor">#</a> Please keep my revision !</h3> <p>In Airflow, there is no notion of dag version, when you changed your dag, the old execution are changed and if you remove a task, the complete task will disappear for <strong>all previous</strong> executions.<br>
No way to understand what is going with previous dags when you update it.</p> <p>Kestra have this in mind and keep all the revision for all flows, and let you watch previous at the state they are, let you watch the diff between revisions, ...</p> <h3 id="where-is-the-rbac"><a href="#where-is-the-rbac" class="header-anchor">#</a> Where is the RBAC ?</h3> <p>Airflow by default have no login, you can enable a lots of <a href="">auths</a> to secure your webserver. but still no RBAC, I mean this team can handle this list of dag!<br>
This is a <a href="http://airflow.apache.org/docs/stable/security.html?highlight=ldap#rbac-ui-security" target="_blank" rel="noopener noreferrer">RBAC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> options, that will allow to specify for each users what <a href="http://airflow.apache.org/docs/stable/security.html?highlight=ldap#dag-level-role" target="_blank" rel="noopener noreferrer">dag role<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> they have.</p> <p>You understand, Users &gt; Dags, where is the group here ? Who want to handle the security user by user ? In a large company, this is <strong>just</strong> impossible!</p></div></div>  <div><div class="footer-top
    position-relative"><div class="shape overflow-hidden text-footer"><svg viewBox="0 0 2880 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 48H1437.5H2880V0H2160C1442.5 52 720 0 720 0H0V48Z" fill="currentColor"></path></svg></div></div> <footer class="footer"><div class="container"><div class="row"><div class="col-lg-3 col-12 mb-0 mb-md-3 pb-0 pb-md-2"><a href="/" class="logo-footer"><img src="/logo.svg" height="60" alt></a> <p class="mt-2">The modern, scalable orchestrator &amp; scheduler open source platform.</p> <ul class="list-unstyled social-icon social mb-0 mt-4"><li class="list-inline-item"><a href="https://github.com/kestra-io" class="rounded"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fea icon-sm fea-social feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></li> <li class="list-inline-item ml-1"><a href="https://twitter.com/kestra_io" class="rounded"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fea icon-sm fea-social feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a></li> <li class="list-inline-item ml-1"><a href="https://www.linkedin.com/company/kestra" class="rounded"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fea icon-sm fea-social feather feather-linkedin"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a></li></ul></div> <div class="col-lg-3 col-12 mb-0 mb-md-3 pb-0 pb-md-2"><h4 class="text-light footer-head">Discover</h4> <ul class="list-unstyled footer-list"><li><a href="/docs/getting-started/" class="text-foot"><i class="mdi mdi-chevron-right mr-1"></i> Getting Started
                            </a></li> <li><a href="/docs/concepts/" class="text-foot"><i class="mdi mdi-chevron-right mr-1"></i> Concepts
                            </a></li> <li><a href="/docs/architecture/" class="text-foot"><i class="mdi mdi-chevron-right mr-1"></i> Architecture
                            </a></li></ul></div> <div class="col-lg-3 col-12 mb-0 mb-md-3 pb-0 pb-md-2"><h4 class="text-light footer-head">Learn</h4> <ul class="list-unstyled footer-list"><li><a href="/docs/developer-guide/" class="text-foot"><i class="mdi mdi-chevron-right mr-1"></i> Developer Guide
                            </a></li> <li><a href="/docs/administrator-guide/" class="text-foot"><i class="mdi mdi-chevron-right mr-1"></i>  Administrator Guide
                            </a></li> <li><a href="/docs/plugin-developer-guide/" class="text-foot"><i class="mdi mdi-chevron-right mr-1"></i>  Plugin Developer Guide
                            </a></li></ul></div> <div class="col-lg-3 col-12 mb-0 mb-md-3 pb-0 pb-md-2"><h4 class="text-light footer-head">Follow</h4> <ul class="list-unstyled footer-list"><li><a href="https://github.com/kestra-io" class="text-foot"><i class="mdi mdi-chevron-right mr-1"></i> GitHub
                            </a></li> <li><a href="https://www.linkedin.com/company/kestra" class="text-foot"><i class="mdi mdi-chevron-right mr-1"></i>  LinkedIn
                            </a></li> <li><a href="https://twitter.com/kestra_io" class="text-foot"><i class="mdi mdi-chevron-right mr-1"></i>  Twitter
                            </a></li></ul></div></div></div></footer> <footer class="footer footer-bar"><div class="container text-center"><div class="row align-items-center"><div class="col-sm-6"><div class="text-sm-left"><p class="mb-0">
                          © 2020 <a href="https://nigh.tech">NighTech</a>.
                          Developed with <i class="mdi mdi-heart text-danger"></i> in 🇫🇷 .
                        </p></div></div></div></div></footer></div></main></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.135e5227.js" defer></script><script src="/assets/js/19.f2b419e8.js" defer></script><script src="/assets/js/1.ca80e02f.js" defer></script><script src="/assets/js/17.a1190153.js" defer></script><script src="/assets/js/10.54554328.js" defer></script>
  </body>
</html>
